import React, {Component} from 'react';
import Layout from '../components/Layout.js';
//import Authentication from '../bin/Authentication.js';
import GoogleLogin from 'react-google-login';
import Auth from '../bin/Auth'

// axios // can use with angular too
// fetch
// fetch.get
// https://crossorigin.me/


class Login extends Component {
  constructor(props){
    super(props);
    this.auth = new Auth();
    //console.log(props);
    this.connection = {};
    this.serverIp = "localhost";
    this.state = {
      value: "",
      username: "",
      password: ""
    }

    var json_string = localStorage.getItem("auth");
    var tempObj = JSON.parse(json_string);
    if (!(tempObj.sessionID === "")){
      window.location.href = ('/');
    }
    this.setUpWebSocket();
  }
  handleSubmit = () => {
    //alert('A username and password was submitted: ' + this.state.username + ' ' + this.state.password);
    this.sendLoginInfo();
  }

  setUpWebSocket = () => {
    //alert('A username and password was submitted: ' + this.state.username + ' ' + this.state.password);
    window.WebSocket = window.WebSocket || window.MozWebSocket;
    if (!window.WebSocket) {
      console.log("No WebSocket available");
      alert('no websocket available');
      return;
    }
    this.connection = new WebSocket('ws://'+this.serverIp+':13379');
    this.connection.onopen = function () {};
    this.connection.onmessage = function(message) {
      try {
        var command = JSON.parse(message.data || message.utf8Data);
        console.log(command);
        if (command.hasOwnProperty('id'))
        {
          if(command.id === 1221313 && command.valid === true){
            //console.log("valid login");
            document.cookie = "username=" + command.id;
            var json_string = localStorage.getItem("auth");
            var tempObj = JSON.parse(json_string);
            tempObj.sessionID = command.id;
            var tempJSON = JSON.stringify(tempObj);
            //console.log("TEMPJSON: ");
            //console.log(tempJSON);
            localStorage.setItem("auth", tempJSON);
          }
        }
        window.location.href = ('/');

      } catch ( e) {
        alert('error: ' + e);
        console.log( e);
        return;
      }
    };
    //alert('damn');

  }

  sendLoginInfo = () => {

    var login = {username: this.state.username, password: this.state.value};
    this.connection.send(JSON.stringify(login));
    //this.connection.send(JSON.stringify(login));
    //this.connection.send(JSON.stringify(login));

    alert(JSON.stringify(login));
    //event.preventDefault();
  }

  handleUserChange = (event) => {
    //this.setState({value: event.target.value.toUpperCase()});
    this.setState({username: event.target.value});
  }
  handlePassChange = (event) => {
    //this.setState({value: event.target.value.toUpperCase()});
    //this.state.password = event.target.value;
    this.setState({password: event.target.value});

    //this.state.value = event.target.value;
    this.setState({value: event.target.value});
    let passLength = this.state.password.length;
    var temp = "";
    for (let i = 0; i < passLength; i++){
      temp += "$";
    }
    this.setState({password: temp});
  }

  handleUserOnKeyPress = (e) => {
    if (e.key === 'Enter') {
      this.handleSubmit();
    } else if (e.key === 'Return'){
      this.handleSubmit();
    }
  }

  handlePassOnKeyPress = (e) => {
    //console.log(e.key);
    if (e.key === 'Enter') {
      this.handleSubmit();
    } else if (e.key === 'Return'){
      this.handleSubmit();
    } else if (e.key === 'Backspace' || e.key === 'Delete'){
      if (this.state.value.length > 0){
        this.setState({value: this.state.value.substring(0, this.state.value.length - 1)});
      } else {

      }
    } else {
      this.setState({value: this.state.value + e.key});
    }

    //this.state.password = e.target.value;
    //this.state.value = e.target.value;
    this.setState({password: this.state.value});
    let passLength = this.state.password.length;
    var temp = "";
    for (let i = 0; i < passLength; i++){
      temp += "$";
    }
    this.setState({password: temp});
  }


  render() {
    const responseGoogleFailure = (response) => {
      console.log("Failure");
      alert("Failed Authentication");
      console.log(response);
    }

    const responseGoogleSuccess = (response) => {
      console.log("Success");
      //window.location.href = "/home";
      console.log(response);
    }

    const styles = {
      submition: {
        position: "relative",
        minHeight: "14px",
        minWidth: "30px",
        width: "15vw",
        margin: "1vw 2vw .5vw 2vw",
        padding: "0 calc(2vw - 10px) 0 calc(2vw - 10px)",
        backgroundColor: "white",
        border: "none",
        fontSize: "calc(2vw - 2px)"
      }
    }


    return (
      <div className="Login">
        <Layout>
            <GoogleLogin
              clientId="212428156672-3ve8lt2j56dg894ghtukgvg8696recc0.apps.googleusercontent.com"
              buttonText="Google Login"
              onSuccess={responseGoogleSuccess}
              onFailure={responseGoogleFailure}
            />
            <label>
              Username:
              <input type="text" value={this.state.username} onChange={this.handleUserChange} onKeyPress={this.handleUserOnKeyPress}/>
            </label>
            <label>
              Password:
              <input type="text" value={this.state.password} onKeyDown={this.handlePassOnKeyPress}/>
            </label>
            <input type="submit" style={styles.submition} value="Submit" onClick={this.handleSubmit}/>
            {/*  <input type="checkbox" checked="checked"/>*/}
        </Layout>
      </div>
    );
  }
}

export default Login;
/*clientId="658977310896-knrl3gka66fldh83dao2rhgbblmd4un9.apps.googleusercontent.com"*/
/*
<NotAuthenticated>
  Not Logged in
</NotAuthenticated>
<Authenticated>
  Logged in
</Authenticated>
 */
