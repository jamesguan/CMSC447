import React, {Component} from 'react';
import Layout from '../components/Layout.js';
//import Authentication from '../bin/Authentication.js';


class Login extends Component {
  constructor(props){
    super(props);
    this.connection;
    this.serverIp = "localhost";
    this.state = {
      value: "",
      username: "",
      password: ""
    }

    this.setUpWebSocket();
  }
  handleSubmit = () => {
    alert('A username and password was submitted: ' + this.state.username + ' ' + this.state.password);
    this.sendLoginInfo();
  }

  setUpWebSocket = () => {
    //alert('A username and password was submitted: ' + this.state.username + ' ' + this.state.password);
    window.WebSocket = window.WebSocket || window.MozWebSocket;
    if (!window.WebSocket) {
      console.log("No WebSocket available");
      alert('no websocket available');
      return;
    }
    this.connection = new WebSocket('ws://'+this.serverIp+':13379');
    this.connection.onopen = function () {};
    this.connection.onmessage = function(message) {
      try {
        var command = JSON.parse(message.data || message.utf8Data);
        console.log(command);
        if (command.hasOwnProperty('username'))
        {
          if(command.id == 1221313 && command.valid == true){
            console.log("valid login");
            document.cookie = "username=" + command.id;
          }
        }

      } catch ( e) {
        alert('error: ' + e);
        console.log( e);
        return;
      }
    };
    //alert('damn');

  }

  sendLoginInfo = () => {

    var login = {username: this.state.username, password: this.state.value};
    this.connection.send(JSON.stringify(login));
    //this.connection.send(JSON.stringify(login));
    //this.connection.send(JSON.stringify(login));

    alert(JSON.stringify(login));
    //event.preventDefault();
  }

  handleUserChange = (event) => {
    //this.setState({value: event.target.value.toUpperCase()});
    this.setState({username: event.target.value});
  }
  handlePassChange = (event) => {
    //this.setState({value: event.target.value.toUpperCase()});
    this.state.password = event.target.value;
    this.state.value = event.target.value;
    let passLength = this.state.password.length;
    var temp = "";
    for (let i = 0; i < passLength; i++){
      temp = temp + "$"
    }
    this.setState({password: temp});
  }

  handleUserOnKeyPress = (e) => {
    if (e.key === 'Enter') {
      this.handleSubmit();
    } else if (e.key === 'Return'){
      this.handleSubmit();
    }
  }

  handlePassOnKeyPress = (e) => {
    console.log(e.key);
    if (e.key === 'Enter') {
      this.handleSubmit();
    } else if (e.key === 'Return'){
      this.handleSubmit();
    } else if (e.key === 'Backspace' || e.key === 'Delete'){
      if (this.state.value.length > 0){
        this.state.value = this.state.value.substring(0, this.state.value.length - 1);
      } else {

      }
    } else {
      this.state.value = this.state.value + e.key;
    }

    //this.state.password = e.target.value;
    //this.state.value = e.target.value;
    this.state.password = this.state.value;
    let passLength = this.state.password.length;
    var temp = "";
    for (let i = 0; i < passLength; i++){
      temp = temp + "$"
    }
    this.setState({password: temp});
  }


  render() {
    const styles = {

    }
    return (
      <div className="Login">
        <Layout>
            <label>
              Username:
              <input type="text" value={this.state.username} onChange={this.handleUserChange} onKeyPress={this.handleUserOnKeyPress}/>
            </label>
            <label>
              Password:
              <input type="text" value={this.state.password} onKeyDown={this.handlePassOnKeyPress}/>
            </label>
            <input type="submit" value="Submit" onClick={this.handleSubmit}/>
            <input type="checkbox" checked="checked"/>
        </Layout>
      </div>
    );
  }
}

export default Login;

/*
<NotAuthenticated>
  Not Logged in
</NotAuthenticated>
<Authenticated>
  Logged in
</Authenticated>
 */
